name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: read

jobs:
  build:
    runs-on: ubuntu-latest   

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: '**/test-results.trx'

  ai-security-scan:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD -- '*.cs' '*.csproj' '*.yml' '*.yaml' '*.json' '*.xml' '*.config' || true)
          if [ -z "$DIFF" ]; then
            echo "No code changes detected."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            # Save diff to file to avoid shell escaping issues
            echo "$DIFF" > /tmp/pr_diff.txt
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: AI Security Review
        if: steps.diff.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          DIFF=$(cat /tmp/pr_diff.txt)
          
          # Truncate diff if too large (max ~12000 chars to fit in context)
          if [ ${#DIFF} -gt 12000 ]; then
            DIFF="${DIFF:0:12000}... [truncated]"
          fi
          
          INSTRUCTIONS=$(cat .github/copilot-code-review.md 2>/dev/null || echo "Review for security issues.")
          
          # Build JSON payload safely using jq
          PAYLOAD=$(jq -n \
            --arg instructions "$INSTRUCTIONS" \
            --arg diff "$DIFF" \
            '{
              model: "gpt-4o-mini",
              messages: [
                { role: "system", content: $instructions },
                { role: "user", content: ("Review this code diff for security vulnerabilities. Respond with a JSON object: {\"passed\": true/false, \"issues\": [\"issue1\", \"issue2\"]}. Set passed=true if no security issues found, passed=false if there are security concerns.\n\nDiff:\n" + $diff) }
              ],
              temperature: 0.1
            }')
          
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD")
          
          # Extract content
          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -z "$CONTENT" ]; then
            echo "::error::Failed to get AI review response"
            echo "$RESPONSE" | jq .
            exit 1
          fi
          
          echo "=== AI Security Review Result ==="
          echo "$CONTENT"
          echo "================================="
          
          # Extract JSON from response (handle markdown code blocks)
          JSON_RESULT=$(echo "$CONTENT" | sed -n 's/.*\({.*}\).*/\1/p' | head -1)
          if [ -z "$JSON_RESULT" ]; then
            JSON_RESULT="$CONTENT"
          fi
          
          PASSED=$(echo "$JSON_RESULT" | jq -r '.passed // empty' 2>/dev/null)
          
          if [ "$PASSED" = "false" ]; then
            echo ""
            echo "::error::AI Security Review FAILED - security issues detected"
            echo "$JSON_RESULT" | jq -r '.issues[]? // empty' 2>/dev/null | while read -r issue; do
              echo "::warning::$issue"
            done
            exit 1
          elif [ "$PASSED" = "true" ]; then
            echo ""
            echo "✅ AI Security Review PASSED - no security issues found"
          else
            echo "::warning::Could not parse AI review result, treating as pass"
          fi

      - name: Skip notice
        if: steps.diff.outputs.skip == 'true'
        run: echo "✅ No code changes to review"
